# ğŸ—£ï¸ Realtime Caption v1.5

> å½“å‰ç‰ˆæœ¬ï¼šv1.5

> ğŸ™ï¸ ä¸€æ¬¾åŸºäº [SenseVoice](https://github.com/FunAudioLLM/SenseVoice) çš„æœ¬åœ°å®æ—¶å­—å¹•ç³»ç»Ÿï¼Œæ”¯æŒç³»ç»ŸéŸ³é¢‘æ•è·ã€è¯­éŸ³è¯†åˆ«ã€å®æ—¶ç¿»è¯‘ä¸å­—å¹•æµ®çª—æ˜¾ç¤ºï¼Œé€‚ç”¨äºä¼šè®®è®°å½•ã€å®æ—¶ç¿»è¯‘ã€ç›´æ’­å­—å¹•ç­‰åœºæ™¯ã€‚

---

## ğŸ†• æ›´æ–°å†…å®¹

- å‰ç«¯äº¤äº’ä¼˜åŒ–
- asræ¨¡å‹ä¸ç¿»è¯‘æ¨¡å‹çº³å…¥ç»Ÿä¸€ç®¡ç†ï¼Œé¦–æ¬¡è¿è¡Œåç«¯æ—¶è‡ªåŠ¨ä¸‹è½½æ¨¡å‹æ–‡ä»¶
- æ”¯æŒæ¨¡å‹çƒ­æ›´æ–°
- ä¼˜åŒ–éŸ³é¢‘é‡‡é›†è®¾å¤‡çš„è¿‡æ»¤é€»è¾‘
---

## ğŸ”§ é¡¹ç›®ç®€ä»‹

**Realtime Caption** æ˜¯ä¸€ä¸ªè¿è¡Œäº Windows å¹³å°çš„æœ¬åœ°å®æ—¶å­—å¹•å·¥å…·ï¼Œæ”¯æŒä»ç³»ç»ŸéŸ³é¢‘ä¸­å®æ—¶æå–è¯­éŸ³å†…å®¹ï¼Œé€šè¿‡å¤§æ¨¡å‹è¿›è¡Œè‡ªåŠ¨è¯­éŸ³è¯†åˆ«ï¼ˆASRï¼‰ï¼Œå¹¶å°†å­—å¹•ä»¥æ‚¬æµ®çª—å½¢å¼å®æ—¶å‘ˆç°ã€‚é€‚ç”¨äºæƒ³è¦æœ¬åœ°éƒ¨ç½²ã€å®‰å…¨ç§æœ‰åŒ–ä½¿ç”¨å®æ—¶è¯­éŸ³è¯†åˆ«çš„ç”¨æˆ·ã€‚

æœ¬é¡¹ç›®åŸºäºå¼€æºè¯­éŸ³æ¨¡å‹ **SenseVoice**ï¼Œç»“åˆ Python åç«¯å’Œ Electron å‰ç«¯æ„å»ºå®Œæ•´å·¥ä½œæµï¼Œæ— éœ€ä¾èµ–äº‘æœåŠ¡ã€‚ç°å·²æ”¯æŒ nllb200 å¤šè¯­è¨€æ¨¡å‹ï¼Œå¯å®ç°å®æ—¶å­—å¹•ç¿»è¯‘ã€‚

---

## âœ¨ åŠŸèƒ½äº®ç‚¹

* âœ… **ç³»ç»ŸéŸ³é¢‘æ•è·**ï¼šåŸºäº WASAPI Loopback æ•æ‰ç³»ç»Ÿæ’­æ”¾çš„å£°éŸ³ï¼Œæ— éœ€éº¦å…‹é£è¾“å…¥ã€‚
* ğŸ§  **è¯­éŸ³è¯†åˆ«æ¨¡å‹**ï¼šé›†æˆ SenseVoice æœ¬åœ°å¤§æ¨¡å‹ï¼Œæ— éœ€è”ç½‘å³å¯è¯†åˆ«æ™®é€šè¯ã€‚
* ğŸŒ **WebSocket é€šè®¯**ï¼šåç«¯é‡‡ç”¨ WebSocket åè®®å®ç°å®æ—¶éŸ³é¢‘ä¼ è¾“ä¸è¯†åˆ«ç»“æœå›ä¼ ã€‚
* ğŸŒ **å®æ—¶ç¿»è¯‘**ï¼šæ”¯æŒ nllb200 å¤šè¯­è¨€æ¨¡å‹ï¼Œè‡ªåŠ¨å°†è¯†åˆ«åˆ°çš„å­—å¹•å®æ—¶ç¿»è¯‘ä¸ºç›®æ ‡è¯­è¨€ï¼Œé€‚ç”¨äºå¤šè¯­ç§ä¼šè®®ã€è·¨å›½äº¤æµç­‰åœºæ™¯ã€‚
* ğŸªŸ **å­—å¹•æ‚¬æµ®çª—**ï¼šElectron å®ç°ç®€æ´å­—å¹•çª—å£ï¼Œé€‚é…ä¸åŒæ¡Œé¢åœºæ™¯ã€‚
* ğŸ”’ **æœ¬åœ°è¿è¡Œ**ï¼šå…¨æµç¨‹æœ¬åœ°æ‰§è¡Œï¼Œæ— éœ€ä¸Šä¼ ä»»ä½•éŸ³é¢‘ï¼Œä¿éšœæ•°æ®éšç§ã€‚

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
Realtime-Caption/
â”œâ”€â”€ a4s/                # åç«¯ä¸»æœåŠ¡ï¼ˆæ¨èä½¿ç”¨æ­¤ç›®å½•ä¸‹çš„ server_wss_split.pyï¼‰
â”œâ”€â”€ python/             # ç³»ç»ŸéŸ³é¢‘æ•è·æ¨¡å—ï¼ˆWASAPI + Sounddeviceï¼‰
â”œâ”€â”€ electron/           # Electronå‰ç«¯ï¼ˆå­—å¹•æ˜¾ç¤ºç•Œé¢ï¼‰
â”œâ”€â”€ nllb200_ct2/        # nllb200ç¿»è¯‘æ¨¡å‹æ–‡ä»¶ï¼ˆéœ€å¦è¡Œä¸‹è½½ï¼‰
â”œâ”€â”€ requirements.txt    # Pythonä¾èµ–ï¼ˆå¦‚æœ‰ï¼‰
â””â”€â”€ README.md
```

> è¯´æ˜ï¼š`api4sensevoice/`ã€`SenseVoice/` ç›®å½•å·²å¼ƒç”¨ï¼Œæ¨èä»…ä½¿ç”¨ `a4s/` åŠç›¸å…³ç›®å½•ã€‚

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

1. å…‹éš†é¡¹ç›®ï¼š

```bash
git clone https://github.com/orangeburn/Realtime-Caption.git
cd Realtime-Caption
```

2. å®‰è£… Python ä¾èµ–ï¼ˆæ¨è conda ç¯å¢ƒï¼‰ï¼š

```bash
conda create -n api4sensevoice python=3.10
conda activate api4sensevoice
conda install -c conda-forge ffmpeg
pip install -r requirements.txt
```

3. å®‰è£… Node.js ä¾èµ–ï¼ˆç”¨äº Electron GUIï¼‰ï¼š

```bash
cd electron
npm install
```

4. å¯åŠ¨åç«¯ WebSocket æœåŠ¡ï¼ˆæ¨èï¼‰ï¼š

```bash
python a4s/server_wss_split.py
```

5. å¯åŠ¨éŸ³é¢‘æ•è·æ¨¡å—ï¼š

```bash
python python/audio_capture_websocket.py
```

6. å¯åŠ¨å‰ç«¯å­—å¹•çª—å£ï¼š

```bash
cd electron
npm start
```

---

## ğŸ“¦ å¤§æ–‡ä»¶ç®¡ç†ä¸æ¨¡å‹æ¢å¤

æœ¬é¡¹ç›®æœªåœ¨ä»“åº“ä¸­ç›´æ¥å­˜å‚¨å¤§æ¨¡å‹æ–‡ä»¶ï¼ˆå¦‚ nllb200_ct2 ä¸‹çš„ model.bin ç­‰ï¼‰ï¼Œè¯·æŒ‰å¦‚ä¸‹æ–¹å¼è·å–å’Œæ¢å¤ï¼š

1. è®¿é—® [JustFrederik/nllb-200-distilled-600M-ct2-int8](https://huggingface.co/JustFrederik/nllb-200-distilled-600M-ct2-int8) ä¸‹è½½æ‰€éœ€æ¨¡å‹æ–‡ä»¶ã€‚
2. å°†ä¸‹è½½çš„æ¨¡å‹æ–‡ä»¶ï¼ˆå¦‚ model.binã€sentencepiece.bpe.modelã€tokenizer.jsonï¼‰æ”¾å…¥ `nllb200_ct2/` ç›®å½•ä¸‹ã€‚
3.  **æ³¨æ„ï¼š** æ¨¡å‹å¤§æ–‡ä»¶å·²è¢« `.gitignore` æ’é™¤ï¼Œéœ€å•ç‹¬ä¸‹è½½åˆ°æœ¬åœ°ã€‚
4. **nllb200_ct2 ä¾èµ– [CTranslate2](https://github.com/OpenNMT/CTranslate2) æ¨ç†å¼•æ“ï¼Œå·²åœ¨ requirements.txt ä¸­å£°æ˜ã€‚è¯·ç¡®ä¿å·²æ­£ç¡®å®‰è£…ã€‚**

---

## ğŸ§© ä¾èµ–ç®¡ç†è¯´æ˜

- **Python ä¾èµ–**ï¼šè¯·ä½¿ç”¨æ ¹ç›®å½•ä¸‹çš„ `requirements.txt` å®‰è£…ï¼Œè™šæ‹Ÿç¯å¢ƒï¼ˆå¦‚ venvã€torch-envï¼‰ä¸ä¼šçº³å…¥ç‰ˆæœ¬æ§åˆ¶ã€‚
- **CTranslate2 ä¾èµ–**ï¼šnllb200_ct2 ç¿»è¯‘æ¨¡å‹ä¾èµ– [CTranslate2](https://github.com/OpenNMT/CTranslate2) æ¨ç†å¼•æ“ï¼Œå·²åœ¨ requirements.txt ä¸­å£°æ˜ã€‚è‹¥é‡åˆ°å®‰è£…é—®é¢˜ï¼Œå¯æ‰‹åŠ¨æ‰§è¡Œï¼š

  ```bash
  pip install ctranslate2
  ```
  
  CTranslate2 ç”¨äºé«˜æ•ˆåŠ è½½å’Œæ¨ç† nllb200_ct2 ç›®å½•ä¸‹çš„å¤šè¯­ç§ç¿»è¯‘æ¨¡å‹ã€‚
- **Node.js ä¾èµ–**ï¼šè¯·åœ¨ `electron/` ç›®å½•ä¸‹è¿è¡Œ `npm install`ï¼Œ`node_modules` ç›®å½•ä¸ä¼šçº³å…¥ç‰ˆæœ¬æ§åˆ¶ã€‚
- **æ¨¡å‹æ–‡ä»¶**ï¼šéœ€æ‰‹åŠ¨ä¸‹è½½æˆ–æœ¬åœ°æ¢å¤ï¼Œé¿å…ä»“åº“å­˜å‚¨å¤§æ–‡ä»¶ã€‚

---

## ğŸ™ é¸£è°¢

* [SenseVoice (by é˜¿é‡Œè¾¾æ‘©é™¢)](https://github.com/FunAudioLLM/SenseVoice) â€” è‡ªåŠ¨è¯­éŸ³è¯†åˆ«æ ¸å¿ƒæ¨¡å‹
* [api4sensevoice](https://github.com/0x5446/api4sensevoice) â€” åŸºäº SenseVoice çš„è½»é‡åŒ–æœåŠ¡å®ç°

---

## ğŸ“œ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ [MIT License](./LICENSE) å¼€æºã€‚

---

# Realtime-Caption: Real-time Streaming Speech Recognition with Speaker Verification

æœ¬é¡¹ç›®åç«¯åŸºäº [SenseVoice](https://github.com/FunAudioLLM/SenseVoice) åŠå¤šæ¨¡å‹èåˆï¼Œæ”¯æŒï¼š
- **VAD æ£€æµ‹**
- **å®æ—¶æµå¼è¯†åˆ«**
- **è¯´è¯äººéªŒè¯**
- å¤šè¯­ç§å­—å¹•ã€WebSocket/HTTP APIã€è®¾å¤‡/è¯­è¨€åŠ¨æ€åˆ‡æ¢ç­‰

---

## æ›´æ–°æ—¥å¿—

#### 2024-09-30
1. ä¼˜åŒ–è¯´è¯äººéªŒè¯ï¼Œç´¯ç§¯éŸ³é¢‘æå‡è¯†åˆ«å‡†ç¡®ç‡ã€‚
2. è¯†åˆ«ç»“æœå¢åŠ  `logprob` å­—æ®µï¼Œä¾¿äºä¸Šå±‚åº”ç”¨åˆ¤æ–­ç½®ä¿¡åº¦ã€‚

---

## å®‰è£…ä¸ä¾èµ–

### å…‹éš†ä»“åº“

```bash
git clone https://github.com/orangeburn/Realtime-Caption.git
cd Realtime-Caption
```

### Python ç¯å¢ƒä¸ä¾èµ–

```bash
conda create -n api4sensevoice python=3.10
conda activate api4sensevoice
conda install -c conda-forge ffmpeg
pip install -r a4s/requirements.txt
```

### ä¾èµ–çš„å¤–éƒ¨æ¨¡å‹/é¡¹ç›®
- [SenseVoice](https://github.com/FunAudioLLM/SenseVoice)
- [ModelScope: speech_campplus_sv_zh_en_16k-common_advanced](https://modelscope.cn/models/iic/speech_campplus_sv_zh_en_16k-common_advanced)
- [ModelScope: speech_fsmn_vad_zh-cn-16k-common-pytorch](https://modelscope.cn/models/iic/speech_fsmn_vad_zh-cn-16k-common-pytorch)

---

## åç«¯è¿è¡Œæ–¹å¼

### å•å¥è¯†åˆ« API æœåŠ¡

```python
if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Run the FastAPI app with a specified port.")
    parser.add_argument('--port', type=int, default=7000, help='Port number to run the FastAPI app on.')
    parser.add_argument('--certfile', type=str, default='path_to_your_certfile', help='SSL certificate file')
    parser.add_argument('--keyfile', type=str, default='path_to_your_keyfile', help='SSL key file')
    args = parser.parse_args()
    uvicorn.run(app, host="0.0.0.0", port=args.port, ssl_certfile=args.certfile, ssl_keyfile=args.keyfile)
```

å¯é€šè¿‡å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šç«¯å£ã€è¯ä¹¦ç­‰ï¼Œç›´æ¥è¿è¡Œï¼š

```bash
python a4s/server.py --port 8888 --certfile path_to_your_certfile --keyfile path_to_your_key
```

#### API è¯´æ˜
- è·¯å¾„ï¼š`/transcribe`  
- æ–¹æ³•ï¼š`POST`  
- è¯·æ±‚ä½“ï¼š`multipart/form-data`ï¼Œå‚æ•° `file`ï¼ˆéŸ³é¢‘æ–‡ä»¶ï¼‰
- å“åº”ï¼š`application/json`ï¼Œå­—æ®µï¼š`code`ã€`info`ã€`data`

è¯·æ±‚ç¤ºä¾‹ï¼š
```bash
curl -X 'POST'  'http://yourapiaddress/transcribe'  -H 'accept: application/json'  -H 'Content-Type: multipart/form-data'  -F 'file=@path_to_your_audio_file'
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "code": 0,
  "msg": "Success",
  "data": {
    // è¯†åˆ«ç»“æœ
  }
}
```

---

### æµå¼å®æ—¶è¯†åˆ« WebSocket æœåŠ¡

```python
if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Run the FastAPI app with a specified port.")
    parser.add_argument('--port', type=int, default=27000, help='Port number to run the FastAPI app on.')
    parser.add_argument('--certfile', type=str, default='path_to_your_certfile', help='SSL certificate file')
    parser.add_argument('--keyfile', type=str, default='path_to_your_keyfile', help='SSL key file')
    args = parser.parse_args()
    uvicorn.run(app, host="0.0.0.0", port=args.port, ssl_certfile=args.certfile, ssl_keyfile=args.keyfile)
```

å¯é€šè¿‡å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šç«¯å£ã€è¯ä¹¦ç­‰ï¼Œç›´æ¥è¿è¡Œï¼š

```bash
python a4s/server_wss_split.py --port 8888 --certfile path_to_your_certfile --keyfile path_to_your_key
```

#### è¯´è¯äººéªŒè¯é…ç½®
1. å‡†å¤‡å¾…éªŒè¯è¯´è¯äººçš„éŸ³é¢‘ï¼ˆ16000é‡‡æ ·ç‡ã€å•é€šé“ã€16bitã€WAVï¼‰ï¼Œæ”¾å…¥ `a4s/speaker/` ç›®å½•ã€‚
2. ä¿®æ”¹ `server_wss_split.py` ä¸­ `reg_spks_files` åˆ—è¡¨ä¸ºä½ çš„éŸ³é¢‘è·¯å¾„ã€‚

```python
reg_spks_files = [
    "speaker/speaker1_a_cn_16k.wav"
]
```

#### WebSocket å‚æ•°
- ç«¯ç‚¹ï¼š`/ws/subscribe`ï¼ˆå­—å¹•è®¢é˜…ï¼‰ `/ws/upload`ï¼ˆéŸ³é¢‘ä¸Šä¼ ï¼‰
- æŸ¥è¯¢å‚æ•°ï¼š`sv`ï¼ˆæ˜¯å¦å¯ç”¨è¯´è¯äººéªŒè¯ï¼Œé»˜è®¤0ï¼‰
- ä¸Šè¡Œæ•°æ®ï¼šPCM äºŒè¿›åˆ¶ï¼ˆå•é€šé“ã€16ké‡‡æ ·ã€16bitï¼‰
- ä¸‹è¡Œæ•°æ®ï¼šJSON å­—ç¬¦ä¸²ï¼Œå­—æ®µï¼š`code`ã€`info`ã€`data`

#### å®¢æˆ·ç«¯æµ‹è¯•é¡µé¢
- `a4s/client_wss.html`ï¼Œä¿®æ”¹ `wsUrl` ä¸ºä½ çš„ WebSocket åœ°å€

```javascript
ws = new WebSocket(`wss://your_wss_server_address/ws/subscribe`);
```

---

## Roadmap
- [x] éŸ³é¢‘é‡‡é›†python
- [x] å®æ—¶ç¿»è¯‘æ¨¡å‹nllb200-ct2æ¥å…¥
- [x] æ­å»ºå‰ç«¯
- [x] é‡‡é›†æ¨¡å—ã€å‰ç«¯ä¸åç«¯æ–­çº¿é‡è¿
- [x] ç¿»è¯‘å­—å¹•ç›®æ ‡è¯­è¨€åˆ‡æ¢
- [x] ç«‹ä½“å£°éŸ³é¢‘é‡‡é›†/éº¦å…‹é£é‡‡é›† åˆ‡æ¢
- [x] ç¦»çº¿è¿è¡Œæ—¶æŠ¥é”™
- [x] å‰ç«¯äº¤äº’ä¼˜åŒ–
- [x] asræ¨¡å‹ä¸ç¿»è¯‘æ¨¡å‹çº³å…¥ç»Ÿä¸€ç®¡ç†ï¼Œé¦–æ¬¡è¿è¡Œåç«¯æ—¶è‡ªåŠ¨ä¸‹è½½æ¨¡å‹æ–‡ä»¶
- [x] æ”¯æŒæ¨¡å‹çƒ­æ›´æ–°
- [x] ä¼˜åŒ–éŸ³é¢‘é‡‡é›†è®¾å¤‡çš„è¿‡æ»¤é€»è¾‘
- [ ] è¯´è¯äººè¯†åˆ«
- [ ] ç¼–è¾‘æ¨¡å¼
- [ ] å½•éŸ³æ–‡ä»¶å¯¼å‡º
- [ ] å­—å¹•å¯¼å‡º

## Contribution
æ¬¢è¿ä»»ä½•å½¢å¼çš„è´¡çŒ®ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š
- Bug åé¦ˆ
- åŠŸèƒ½å»ºè®®
- ä»£ç æäº¤
- æ–‡æ¡£å®Œå–„

## License
MIT Licenseï¼Œè¯¦è§ LICENSE æ–‡ä»¶ã€‚
